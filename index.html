<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Funciones Racionales</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        h2 { margin-top: 30px; }
        input {
            width: 100%;
            padding: 10px;
            font-size: 18px;
            margin-top: 5px;
            margin-bottom: 12px;
        }
        button {
            padding: 10px 18px;
            font-size: 16px;
            cursor: pointer;
            background: #2b6cb0;
            color: white;
            border: none;
            border-radius: 5px;
        }
        .result-box, .graph-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 7px;
            text-align: center;
        }
        th { background: #eee; }
        .indeterminado { color: red; }
    </style>
</head>

<body>
<div class="container">

    <h1>Calculadora de Funciones Racionales</h1>

    <p><strong>Ejemplo:</strong> (x² - 4) / (x - 2)</p>

    <label for="funcion"><strong>Ingresa tu función racional:</strong></label>
    <input id="funcion" placeholder="Ejemplo: (x^2 - 4) / (x - 2)" />

    <button onclick="procesar()">Calcular</button>

    <p style="margin-top:10px;"><em>Guía rápida: Usa ^ para potencias, paréntesis para agrupar y x como variable.</em></p>

    <div id="resultados" class="result-box"></div>

    <div class="graph-box">
        <canvas id="grafica" height="260"></canvas>
    </div>

</div>

<script>
// --- Redondeo a máximo 2 decimales ---
function r2(x) {
    if (typeof x !== "number" || !isFinite(x)) return x;
    return Math.round(x * 100) / 100;
}

// --- Detecta si un número requiere más de 2 decimales ---
function tieneMuchosDecimales(n) {
    if (!isFinite(n)) return true;
    let s = n.toString();
    return s.includes(".") && s.split(".")[1].length > 2;
}

// --- Procesar función ---
function procesar() {
    const entrada = document.getElementById("funcion").value.trim();
    const R = document.getElementById("resultados");
    if (entrada === "") {
        R.innerHTML = "<p>Ingresa una función.</p>";
        return;
    }

    let expr;
    try {
        expr = math.parse(entrada);
    } catch {
        R.innerHTML = "<p>Error: función inválida.</p>";
        return;
    }

    let f;
    try {
        f = expr.compile();
    } catch {
        R.innerHTML = "<p>Error procesando la función.</p>";
        return;
    }

    // Evaluador seguro
    function evalF(x) {
        try {
            return f.evaluate({ x });
        } catch {
            return NaN;
        }
    }

    // --- DOMINIO, HUECOS y ASÍNTOTAS ---
    let huecos = [];
    let posiblesAsintotasVerticales = [];

    // Buscamos ceros del denominador escaneando
    for (let x = -100; x <= 100; x += 0.1) {
        let val = evalF(x);
        if (!isFinite(val)) {
            let aproximado = r2(x);
            if (!huecos.includes(aproximado)) huecos.push(aproximado);
        }
    }

    let dominio = "ℝ \\ { " + huecos.join(" , ") + " }";

    // --- ASÍNTOTA HORIZONTAL U OBLICUA ---
    // Intentamos aproximar límite cuando x→∞
    let v1 = evalF(100000);
    let v2 = evalF(120000);

    let tipoAsint = "";
    if (isFinite(v1) && isFinite(v2) && Math.abs(v1 - v2) < 1) {
        tipoAsint = "y = " + r2((v1 + v2) / 2);
    } else {
        // Aproximar recta oblicua por regresión
        let xs = [];
        let ys = [];
        for (let i = 50000; i <= 60000; i += 2000) {
            let y = evalF(i);
            if (isFinite(y)) {
                xs.push(i);
                ys.push(y);
            }
        }
        if (xs.length >= 2) {
            let n = xs.length;
            let sumX = xs.reduce((a, b) => a + b, 0);
            let sumY = ys.reduce((a, b) => a + b, 0);
            let sumXY = xs.map((e, i) => e * ys[i]).reduce((a, b) => a + b, 0);
            let sumX2 = xs.map(e => e * e).reduce((a, b) => a + b, 0);

            let m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            let b = (sumY - m * sumX) / n;

            m = r2(m);
            b = r2(b);
            tipoAsint = "y = " + m + "x + " + b;
        }
    }

    // --- RANGO (solo si posible y ≤ 2 decimales) ---
    let posiblesValores = [];
    for (let x = -50; x <= 50; x += 0.25) {
        let y = evalF(x);
        if (isFinite(y)) posiblesValores.push(y);
    }

    let minY = Math.min(...posiblesValores);
    let maxY = Math.max(...posiblesValores);

    let mostrarRango = !(tieneMuchosDecimales(minY) || tieneMuchosDecimales(maxY));

    // --- TABLA ---
    let tabla = "<table><tr><th>x</th><th>f(x)</th></tr>";
    for (let i = -3; i <= 5; i++) {
        let v = evalF(i);
        if (!isFinite(v)) {
            tabla += `<tr><td>${i}</td><td class="indeterminado">indefinido</td></tr>`;
        } else {
            tabla += `<tr><td>${i}</td><td>${r2(v)}</td></tr>`;
        }
    }
    tabla += "</table>";

    // --- MOSTRAR RESULTADOS ---
    let html = "";

    html += "<h2>Resultados</h2>";

    html += `<p><strong>Dominio:</strong> ${dominio}</p>`;

    html += `<p><strong>Asíntotas:</strong> ${tipoAsint || "Ninguna"}</p>`;

    if (huecos.length > 0)
        html += `<p><strong>Huecos:</strong> x = ${huecos.join(", ")}</p>`;

    if (mostrarRango) {
        let rangoMat = `( ${r2(minY)}, ${r2(maxY)} )`;
        let rangoText = `Valores entre ${r2(minY)} y ${r2(maxY)}`;
        html += `<p><strong>Rango:</strong> ${rangoMat} — ${rangoText}</p>`;
    }

    html += "<h3>Tabla de valores</h3>";
    html += tabla;

    R.innerHTML = html;

    // --- GRÁFICA ---
    let ctx = document.getElementById("grafica").getContext("2d");

    if (window.miGrafica) window.miGrafica.destroy();

    let puntos = [];
    for (let x = -10; x <= 10; x += 0.1) {
        let y = evalF(x);
        if (isFinite(y)) puntos.push({ x, y });
    }

    window.miGrafica = new Chart(ctx, {
        type: "line",
        data: {
            datasets: [{
                label: "f(x)",
                data: puntos,
                parsing: false,
                borderWidth: 2,
                pointRadius: 0,
            }]
        },
        options: {
            scales: {
                x: { type: "linear" },
                y: { type: "linear" }
            }
        }
    });
}
</script>

</body>
</html>
