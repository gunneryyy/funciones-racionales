<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rational Function Analyzer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
    body {
        font-family: Arial;
        margin: 0;
        padding: 20px;
        display: flex;
        gap: 20px;
    }
    .left {
        width: 40%;
    }
    .plot {
        width: 60%;
    }
    input, button {
        width: 100%;
        padding: 8px;
        margin-top: 10px;
        font-size: 16px;
    }
    table {
        width: 100%;
        margin-top: 15px;
        border-collapse: collapse;
    }
    th, td {
        padding: 5px;
        border: 1px solid #aaa;
        text-align: center;
    }
</style>
</head>

<body>

<div class="left">
    <h2>Rational Function Analyzer</h2>

    <label>Numerator:</label>
    <input id="numInput" placeholder="e.g. 2x^2 - 4">

    <label>Denominator:</label>
    <input id="denInput" placeholder="e.g. x - 2">

    <button onclick="analyze()">Analyze</button>

    <h3>Sample Table</h3>
    <table id="table">
        <tr><th>x</th><th>f(x)</th></tr>
    </table>
</div>

<div class="plot" id="graph"></div>

<script>

// Insert automatic multiplication: 2x â†’ 2*x
function fixExpr(expr){
    expr = expr.replace(/(\d)(x)/gi, "$1*$2");
    expr = expr.replace(/x(\d)/gi, "x*$1");
    return expr;
}

// Evaluate numerator and denominator separately
function buildEvaluator(expr){
    try {
        const node = math.parse(expr);
        const code = node.compile();
        return x => {
            const v = code.evaluate({x});
            return (isFinite(v) ? v : NaN);
        };
    } catch {
        return () => NaN;
    }
}

// Safer adaptive sampling
function adaptiveSample(f, a, b, fa, fb, tol=0.5, depth=0, maxDepth=12){
    const mid = (a + b) / 2;
    const fm = f(mid);

    if(!isFinite(fa) || !isFinite(fb) || !isFinite(fm)){
        return [
            {x: a, y: isFinite(fa)?fa:null},
            {x: mid, y: null},
            {x: b, y: isFinite(fb)?fb:null}
        ];
    }

    const lin = (fa + fb) / 2;
    const err = Math.abs(fm - lin);

    if(err < tol || depth >= maxDepth){
        return [
            {x:a, y:fa},
            {x:mid, y:fm},
            {x:b, y:fb}
        ];
    }

    const left = adaptiveSample(f, a, mid, fa, fm, tol, depth+1, maxDepth);
    const right = adaptiveSample(f, mid, b, fm, fb, tol, depth+1, maxDepth);

    return [...left, ...right.slice(1)];
}

// Build full rational function evaluator
function buildRational(numEval, denEval){
    return (x)=>{
        let d = denEval(x);
        let n = numEval(x);
        if(!isFinite(d) || Math.abs(d) < 1e-12) return NaN;
        let v = n / d;
        return isFinite(v)?v:NaN;
    };
}

function analyze(){
    const numStr = fixExpr(document.getElementById("numInput").value);
    const denStr = fixExpr(document.getElementById("denInput").value);

    const evalNum = buildEvaluator(numStr);
    const evalDen = buildEvaluator(denStr);
    const f = buildRational(evalNum, evalDen);

    let a = -10, b = 10;
    let fa = f(a), fb = f(b);
    const pts = adaptiveSample(f, a, b, fa, fb);

    // GRAPH
    Plotly.newPlot("graph", [{
        x: pts.map(p=>p.x),
        y: pts.map(p=>p.y),
        mode:"lines",
        connectgaps:false
    }], {margin:{t:20}});

    // TABLE
    const tbl = document.getElementById("table");
    tbl.innerHTML = "<tr><th>x</th><th>f(x)</th></tr>";

    for(let x=-5; x<=5; x++){
        let y = f(x);
        tbl.innerHTML += `<tr><td>${x}</td><td>${isFinite(y)?y.toFixed(3):"indefinido"}</td></tr>`;
    }
}

</script>
</body>
</html>
